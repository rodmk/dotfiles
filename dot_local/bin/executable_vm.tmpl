#!/bin/bash
set -e

VM_NAME="dev"
VM_USER="dev"
VM_TYPE="cpx11"
VM_LOCATION="hil"
VM_IMAGE="ubuntu-24.04"
VM_SSH_KEY="Hetzner SSH Key"
VM_FIREWALL="dev-fw"

# shellcheck disable=SC1083
LIB_DIR={{ .chezmoi.sourceDir | quote }}/lib

vm_ip() {
    hcloud server ip -6 "$VM_NAME" | sed 's|/64$|1|'
}

vm_firewall() {
    hcloud firewall describe "$VM_FIREWALL" >/dev/null 2>&1 || hcloud firewall create --name "$VM_FIREWALL"
    hcloud firewall replace-rules --rules-file "$LIB_DIR/firewall.json" "$VM_FIREWALL"
}

vm_create() {
    vm_firewall
    hcloud server create \
        --name "$VM_NAME" \
        --type "$VM_TYPE" \
        --location "$VM_LOCATION" \
        --image "$VM_IMAGE" \
        --ssh-key "$VM_SSH_KEY" \
        --firewall "$VM_FIREWALL" \
        --without-ipv4 \
        --user-data-from-file "$LIB_DIR/cloud-init.yaml"
}

vm_wait() {
    echo "Waiting for SSH and cloud-init..."
    until ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -o PasswordAuthentication=no "$VM_USER@$(vm_ip)" "cloud-init status --wait" 2>/dev/null; do
        sleep 3
    done
    echo "Ready: $VM_USER@$(vm_ip)"
}

vm_rebuild() {
    ssh-keygen -R "$(vm_ip)" 2>/dev/null || true
    hcloud server rebuild \
        --image "$VM_IMAGE" \
        --user-data-from-file "$LIB_DIR/cloud-init.yaml" \
        "$VM_NAME"
    vm_wait
}

vm_destroy() {
    ssh-keygen -R "$(vm_ip)" 2>/dev/null || true
    hcloud server delete "$VM_NAME"
}

vm_up() {
    if hcloud server describe "$VM_NAME" >/dev/null 2>&1; then
        echo "Server '$VM_NAME' already running at $(vm_ip)"
        return
    fi
    vm_create
    vm_wait
}

vm_ssh() {
    ssh "$VM_USER@$(vm_ip)"
}

vm_mosh() {
    mosh "$VM_USER@$(vm_ip)"
}

case "${1:-}" in
    up)      vm_up ;;
    rebuild) vm_rebuild ;;
    destroy) vm_destroy ;;
    create)  vm_create ;;
    ssh)     vm_ssh ;;
    mosh)    vm_mosh ;;
    ip)      vm_ip ;;
    *)       echo "Usage: vm {up|rebuild|destroy|create|ssh|mosh|ip}" ;;
esac
