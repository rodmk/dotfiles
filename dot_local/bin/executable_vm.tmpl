#!/bin/bash
set -e

VM_NAME="dev"
VM_USER="dev"
VM_IMAGE="ubuntu-24.04"

# shellcheck disable=SC1083
TF_DIR={{ .chezmoi.sourceDir | quote }}/lib/terraform
# shellcheck disable=SC1083
LIB_DIR={{ .chezmoi.sourceDir | quote }}/lib

export HCLOUD_TOKEN
HCLOUD_TOKEN=$(op read "op://Development/Hetzner API/token")

tf() {
    [ -d "$TF_DIR/.terraform" ] || terraform -chdir="$TF_DIR" init -input=false
    terraform -chdir="$TF_DIR" "$@"
}

vm_ip() {
    local ip
    if ! ip=$(tf output -raw ip 2>/dev/null) || [ -z "$ip" ]; then
        echo "No VM running" >&2
        return 1
    fi
    echo "$ip"
}

tf_import() {
    local resource=$1 type=$2 name=$3
    if ! tf state list 2>/dev/null | grep -q "$resource"; then
        local id
        if id=$(hcloud "$type" describe "$name" -o format='{{ "{{.ID}}" }}'); then
            tf import "$resource" "$id"
        fi
    fi
}

vm_wait() {
    local host="$VM_USER@$(vm_ip)"
    local ssh_opts="-o StrictHostKeyChecking=no -o ConnectTimeout=5 -o PasswordAuthentication=no"
    SECONDS=0
    echo "Waiting for SSH..."
    # shellcheck disable=SC2086
    until ssh $ssh_opts "$host" true 2>/dev/null; do
        if (( SECONDS >= 60 )); then
            echo "SSH not available after 60s, check connectivity:" >&2
            # shellcheck disable=SC2086
            ssh $ssh_opts "$host" true
            return 1
        fi
        sleep 3
    done

    echo "Waiting for cloud-init (tailing log)..."
    # shellcheck disable=SC2086
    ssh $ssh_opts "$host" "sudo tail -f /var/log/cloud-init-output.log & cloud-init status --wait >/dev/null; kill %1 2>/dev/null"
    echo "Ready: $host"
}

tf_sync() {
    tf_import hcloud_firewall.dev firewall dev-fw
    tf_import hcloud_server.dev server "$VM_NAME"
}

vm_up() {
    if tf state list 2>/dev/null | grep -q hcloud_server.dev; then
        echo "Server '$VM_NAME' already running at $(vm_ip)" >&2
        return
    fi
    tf_sync
    tf apply -auto-approve
    vm_wait
}

vm_rebuild() {
    ssh-keygen -R "$(vm_ip)" 2>/dev/null || true
    hcloud server rebuild \
        --image "$VM_IMAGE" \
        --user-data-from-file "$LIB_DIR/cloud-init.yaml" \
        "$VM_NAME"
    vm_wait
}

vm_destroy() {
    ssh-keygen -R "$(vm_ip)" 2>/dev/null || true
    tf destroy -auto-approve
}

vm_status() {
    tf_sync
    if ! tf state list 2>/dev/null | grep -q hcloud_server.dev; then
        echo "Not running"
        return
    fi
    echo "Status: $(tf output -raw status)"
    echo "IP:     $(tf output -raw ip)"
}

vm_ssh() {
    vm_up
    ssh "$VM_USER@$(vm_ip)"
}

vm_mosh() {
    vm_up
    mosh "$VM_USER@$(vm_ip)"
}

vm_et() {
    vm_up
    et "$VM_USER@$(vm_ip)"
}

case "${1:-}" in
    up)      vm_up ;;
    rebuild) vm_rebuild ;;
    destroy) vm_destroy ;;
    status)  vm_status ;;
    ssh)     vm_ssh ;;
    mosh)    vm_mosh ;;
    et)      vm_et ;;
    ip)      vm_ip ;;
    *)       echo "Usage: vm {up|rebuild|destroy|status|ssh|mosh|et|ip}" ;;
esac
