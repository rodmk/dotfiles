#!/bin/bash
set -e

VM_NAME="dev"
VM_USER="dev"
VM_IMAGE="ubuntu-24.04"

# shellcheck disable=SC1083
TF_DIR={{ .chezmoi.sourceDir | quote }}/lib/terraform
# shellcheck disable=SC1083
LIB_DIR={{ .chezmoi.sourceDir | quote }}/lib

tf() {
    [ -d "$TF_DIR/.terraform" ] || terraform -chdir="$TF_DIR" init -input=false
    terraform -chdir="$TF_DIR" "$@"
}

vm_ip() {
    local ip
    if ! ip=$(tf output -raw ip 2>/dev/null) || [ -z "$ip" ]; then
        echo "No VM running" >&2
        return 1
    fi
    echo "$ip"
}

tf_import() {
    local resource=$1 name=$2
    local type=${resource%%.*}
    type=${type#hcloud_}
    if ! tf state list 2>/dev/null | grep -q "$resource"; then
        local id
        if id=$(hcloud "$type" describe "$name" -o format='{{ "{{.ID}}" }}'); then
            tf import "$resource" "$id"
        fi
    fi
}

vm_wait() {
    local host
    host="$VM_USER@$(vm_ip)"
    local ssh_opts="-o StrictHostKeyChecking=no -o ConnectTimeout=5 -o PasswordAuthentication=no"
    SECONDS=0
    echo "Waiting for SSH..."
    # shellcheck disable=SC2086
    until ssh $ssh_opts "$host" true 2>/dev/null; do
        if (( SECONDS >= 60 )); then
            echo "SSH not available after 60s, check connectivity:" >&2
            # shellcheck disable=SC2086
            ssh $ssh_opts "$host" true
            return 1
        fi
        sleep 3
    done

    echo "Waiting for cloud-init (tailing log)..."
    # shellcheck disable=SC2086
    ssh $ssh_opts "$host" "sudo tail -f /var/log/cloud-init-output.log & cloud-init status --wait >/dev/null; kill %1 2>/dev/null"
    echo "Ready: $host"
}

tf_sync() {
    export HCLOUD_TOKEN
    HCLOUD_TOKEN=$(op read "op://Development/Hetzner API/token")
    local resource name
    while IFS=$'\t' read -r resource name; do
        tf_import "$resource" "$name"
    done < <(jq -r 'to_entries[] | [.key, .value] | @tsv' "$TF_DIR/imports.json")
}

vm_up() {
    if tf state list 2>/dev/null | grep -q hcloud_server.dev; then
        echo "Server '$VM_NAME' already running at $(vm_ip)" >&2
        return
    fi
    tf apply -auto-approve
    vm_wait
}

vm_rebuild() {
    ssh-keygen -R "$(vm_ip)" 2>/dev/null || true
    hcloud server rebuild \
        --image "$VM_IMAGE" \
        --user-data-from-file "$LIB_DIR/cloud-init.yaml" \
        "$VM_NAME"
    vm_wait
}

vm_destroy() {
    ssh-keygen -R "$(vm_ip)" 2>/dev/null || true
    tf destroy -auto-approve
}

vm_status() {
    if ! tf state list 2>/dev/null | grep -q hcloud_server.dev; then
        echo "Not running"
        return
    fi
    echo "Status: $(tf output -raw status)"
    echo "IP:     $(tf output -raw ip)"
}

vm_connect() {
    vm_up
    local host
    host="$VM_USER@$(vm_ip)"
    op read "op://Private/Service Account Auth Token: Development/credential" \
        | ssh "$host" "mkdir -p ~/.config/op && umask 077 && cat > ~/.config/op/service-account-token"
    "$1" "$host"
}

case "${1:-}" in
    up|rebuild|destroy|status|ssh|mosh|et|ip)
        tf_sync
        ;;
    *)
        echo "Usage: vm {up|rebuild|destroy|status|ssh|mosh|et|ip}"
        exit 1
        ;;
esac

case "$1" in
    up)      vm_up ;;
    rebuild) vm_rebuild ;;
    destroy) vm_destroy ;;
    status)  vm_status ;;
    ssh|mosh|et) vm_connect "$1" ;;
    ip)      vm_ip ;;
esac
