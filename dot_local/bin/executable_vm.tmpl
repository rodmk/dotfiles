#!/bin/bash
set -e

VM_NAME="dev"
VM_USER="dev"
VM_IMAGE="ubuntu-24.04"

# shellcheck disable=SC1083
TF_DIR={{ .chezmoi.sourceDir | quote }}/lib/terraform
# shellcheck disable=SC1083
LIB_DIR={{ .chezmoi.sourceDir | quote }}/lib

export HCLOUD_TOKEN
HCLOUD_TOKEN=$(op read "op://Private/Hetzner API/token")

tf() {
    [ -d "$TF_DIR/.terraform" ] || terraform -chdir="$TF_DIR" init -input=false
    terraform -chdir="$TF_DIR" "$@"
}

vm_ip() { tf output -raw ip; }

vm_wait() {
    echo "Waiting for SSH and cloud-init..."
    until ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -o PasswordAuthentication=no "$VM_USER@$(vm_ip)" "cloud-init status --wait" 2>/dev/null; do
        sleep 3
    done
    echo "Ready: $VM_USER@$(vm_ip)"
}

vm_up() {
    if tf output -raw ip >/dev/null 2>&1; then
        echo "Server '$VM_NAME' already running at $(vm_ip)" >&2
        return
    fi
    tf apply -auto-approve
    vm_wait
}

vm_rebuild() {
    ssh-keygen -R "$(vm_ip)" 2>/dev/null || true
    hcloud server rebuild \
        --image "$VM_IMAGE" \
        --user-data-from-file "$LIB_DIR/cloud-init.yaml" \
        "$VM_NAME"
    vm_wait
}

vm_destroy() {
    ssh-keygen -R "$(vm_ip)" 2>/dev/null || true
    tf destroy -auto-approve
}

vm_status() {
    echo "Status: $(tf output -raw status)"
    echo "IP:     $(tf output -raw ip)"
}

vm_ssh() {
    vm_up
    ssh "$VM_USER@$(vm_ip)"
}

vm_mosh() {
    vm_up
    mosh "$VM_USER@$(vm_ip)"
}

case "${1:-}" in
    up)      vm_up ;;
    rebuild) vm_rebuild ;;
    destroy) vm_destroy ;;
    status)  vm_status ;;
    ssh)     vm_ssh ;;
    mosh)    vm_mosh ;;
    ip)      vm_ip ;;
    *)       echo "Usage: vm {up|rebuild|destroy|status|ssh|mosh|ip}" ;;
esac
