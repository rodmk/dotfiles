# shellcheck shell=bash
is_bash=
is_zsh=
if [ -n "$ZSH_VERSION" ]; then
    is_zsh=1
elif [ -n "$BASH_VERSION" ]; then
    is_bash=1
fi

# ============================================================================
# PATH
# ============================================================================

export PATH="$HOME/.local/bin:$HOME/bin:$PATH"

# ============================================================================
# EDITOR
# ============================================================================

export EDITOR='vim'

# ============================================================================
# PAGER
# ============================================================================

# R: ANSI color support
# F: quit if output fits on one screen
# i: case-insensitive search (unless uppercase used)
# M: verbose prompt with line numbers and percentage
export LESS='-RFiM'

# ============================================================================
# COLORS
# ============================================================================

export CLICOLOR=1
export LSCOLORS=Gxfxcxdxbxegedabagacad

# ============================================================================
# HISTORY
# ============================================================================

export HISTSIZE=10000
export SAVEHIST=10000

[ "$is_zsh" ] && {
    setopt APPEND_HISTORY
    setopt HIST_IGNORE_DUPS
    setopt HIST_FIND_NO_DUPS
    setopt HIST_IGNORE_ALL_DUPS
    setopt HIST_SAVE_NO_DUPS
    setopt SHARE_HISTORY
}

[ "$is_bash" ] && {
    export HISTFILESIZE=20000
    export HISTCONTROL=ignoredups:erasedups
    shopt -s histappend
}

# ============================================================================
# COMPLETION
# ============================================================================

[ "$is_zsh" ] && {
    # shellcheck disable=SC2206
    fpath=(~/.local/share/zsh/site-functions $fpath)
    autoload -Uz compinit && compinit
}

[ "$is_bash" ] && {
    # shellcheck source=/dev/null
    [ -f /etc/bash_completion ] && . /etc/bash_completion
    # shellcheck source=/dev/null
    [ -f /usr/local/etc/bash_completion ] && . /usr/local/etc/bash_completion
}

# ============================================================================
# PROMPT
# ============================================================================

_is_remote() {
    [ -n "$SSH_CONNECTION" ] || [ -n "$SSH_TTY" ] || \
    [ "$(ps -o comm= -p "$PPID" 2>/dev/null)" = "mosh-server" ]
}

_remote_name=
_is_remote && _remote_name="${CODER_WORKSPACE_NAME:-$(hostname -s)}"

get_git_branch() {
    git symbolic-ref --short HEAD 2>/dev/null || \
    git describe --tags --exact-match 2>/dev/null || \
    git rev-parse --short HEAD 2>/dev/null
}

[ "$is_zsh" ] && {
    _zsh_precmd() {
        local branch dir remote_prefix="" branch_part=""
        branch=$(get_git_branch)
        dir=${PWD/#$HOME/\~}
        [ -n "$_remote_name" ] && remote_prefix="%F{magenta}[${_remote_name}]%f "
        [ -n "$branch" ] && branch_part=" %F{yellow}(${branch})%f"
        # shellcheck disable=SC2034
        PROMPT="${remote_prefix}%F{cyan}${dir}%f${branch_part} %# "
    }
    precmd_functions+=(_zsh_precmd)
}

[ "$is_bash" ] && {
    _prompt_command() {
        local branch remote_prefix="" branch_part=""
        branch=$(get_git_branch)
        [ -n "$_remote_name" ] && remote_prefix="\[\033[35m\][${_remote_name}]\[\033[0m\] "
        [ -n "$branch" ] && branch_part=" \[\033[33m\]($branch)\[\033[0m\]"
        PS1="${remote_prefix}\[\033[36m\]$(pwd | sed "s|$HOME|~|")\[\033[0m\]${branch_part} \$ "
    }
    PROMPT_COMMAND=_prompt_command
}

# ============================================================================
# DIRENV
# ============================================================================

if command -v direnv >/dev/null 2>&1; then
    [ "$is_zsh" ] && {
        eval "$(direnv hook zsh)"
    }
    [ "$is_bash" ] && {
        eval "$(direnv hook bash)"
    }
fi

# ============================================================================
# ALIASES
# ============================================================================

alias g='git'
alias tm='tmux new-session -A -s main'
# shellcheck disable=SC1083
alias dotfiles-deps='{{ .chezmoi.sourceDir | quote }}/lib/install-packages.sh'

alias yoloclaude='claude --dangerously-skip-permissions --model opus'
