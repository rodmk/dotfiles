# shellcheck shell=bash
is_bash=
is_zsh=
if [ -n "$ZSH_VERSION" ]; then
    is_zsh=1
elif [ -n "$BASH_VERSION" ]; then
    is_bash=1
fi

# ============================================================================
# PATH
# ============================================================================

export PATH="$HOME/.local/bin:$PATH"

# ============================================================================
# EDITOR
# ============================================================================

export EDITOR='vim'

# ============================================================================
# PAGER
# ============================================================================

# R: ANSI color support
# F: quit if output fits on one screen
# i: case-insensitive search (unless uppercase used)
# M: verbose prompt with line numbers and percentage
export LESS='-RFiM'

# ============================================================================
# COLORS
# ============================================================================

export CLICOLOR=1
export LSCOLORS=Gxfxcxdxbxegedabagacad

# ============================================================================
# HISTORY
# ============================================================================

export HISTSIZE=10000
export SAVEHIST=10000

[ "$is_zsh" ] && {
    setopt APPEND_HISTORY
    setopt HIST_IGNORE_DUPS
    setopt HIST_FIND_NO_DUPS
    setopt HIST_IGNORE_ALL_DUPS
    setopt HIST_SAVE_NO_DUPS
    setopt SHARE_HISTORY
}

[ "$is_bash" ] && {
    export HISTFILESIZE=20000
    export HISTCONTROL=ignoredups:erasedups
    shopt -s histappend
}

# ============================================================================
# COMPLETION
# ============================================================================

[ "$is_zsh" ] && {
    autoload -Uz compinit && compinit
}

[ "$is_bash" ] && {
    # shellcheck source=/dev/null
    [ -f /etc/bash_completion ] && . /etc/bash_completion
    # shellcheck source=/dev/null
    [ -f /usr/local/etc/bash_completion ] && . /usr/local/etc/bash_completion
}

# ============================================================================
# PROMPT
# ============================================================================

get_git_branch() {
    git symbolic-ref --short HEAD 2>/dev/null || \
    git describe --tags --exact-match 2>/dev/null || \
    git rev-parse --short HEAD 2>/dev/null
}

_prompt_command() {
    local branch
    branch=$(get_git_branch)
    if [ -n "$branch" ]; then
        PS1="\[\033[36m\]$(pwd | sed "s|$HOME|~|")\[\033[0m\] \[\033[33m\]($branch)\[\033[0m\] \$ "
    else
        PS1="\[\033[36m\]$(pwd | sed "s|$HOME|~|")\[\033[0m\] \$ "
    fi
}

[ "$is_zsh" ] && {
    _zsh_precmd() {
        local branch dir
        branch=$(get_git_branch)
        dir=${PWD/#$HOME/\~}
        if [ -n "$branch" ]; then
            # shellcheck disable=SC2034
            PROMPT="%F{cyan}${dir}%f %F{yellow}(${branch})%f %# "
        else
            # shellcheck disable=SC2034
            PROMPT="%F{cyan}${dir}%f %# "
        fi
    }
    precmd_functions+=(_zsh_precmd)
}

[ "$is_bash" ] && {
    PROMPT_COMMAND=_prompt_command
}

# ============================================================================
# DIRENV
# ============================================================================

if command -v direnv >/dev/null 2>&1; then
    [ "$is_zsh" ] && {
        eval "$(direnv hook zsh)"
    }
    [ "$is_bash" ] && {
        eval "$(direnv hook bash)"
    }
fi

# ============================================================================
# ALIASES
# ============================================================================

alias g='git'
alias tm='tmux new-session -A -s main'
# shellcheck disable=SC1083
alias dotfiles-deps='{{ .chezmoi.sourceDir | quote }}/lib/install-packages.sh'

alias yoloclaude='claude --dangerously-skip-permissions --model opus'

# shellcheck disable=SC1083
alias vm-firewall='hcloud firewall describe dev-fw >/dev/null 2>&1 || hcloud firewall create --name dev-fw; hcloud firewall replace-rules --rules-file {{ .chezmoi.sourceDir | quote }}/lib/firewall.json dev-fw'
# shellcheck disable=SC1083
alias vm-create='vm-firewall && hcloud server create --name dev --type cpx11 --location hil --image ubuntu-24.04 --ssh-key "Hetzner SSH Key" --firewall dev-fw --user-data-from-file {{ .chezmoi.sourceDir | quote }}/cloud-init.yaml'
alias vm-destroy='hcloud server delete dev'
alias vm-up='vm-destroy; vm-create'
alias vm-ssh='ssh dev@$(hcloud server ip dev)'
alias vm-mosh='mosh dev@$(hcloud server ip dev)'
